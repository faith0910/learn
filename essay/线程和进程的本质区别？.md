线程和进程的本质区别？

进程是cpu资源分配的基本单位

线程是cpu调度的基本单位（cpu真正运行的是线程）

线程是建议在进程上基础上的一次程序运行单位。

ALU:基本运算单元

pc：记录程序执行的位置（上下文）

RE：存储

线程切换？

​		对于单核CPU来说（对于多核CPU，此处就理解为一个核），CPU在一个时刻只能运行一个线程，当在运行一个线程的过程中转去运行另外一个线程，这个叫做线程上下文切换（对于进程也是类似）。

​	（保护现场）

​		程序计数器是一块较小的内存空间，它可以看作是当前线程所执行字节码的行号指示器。在虚拟机的概念模型里（仅是概念模型，各种虚拟机可能会通过一些更高效的方式去实现），字节解释器工作时就是通过改变这个计数器的值来选取下一条需要执行的字节码指令。且由于java虚拟机的多线程是通过线程轮流切换并分配器执行时间的方式来实现的，在任何一个确定的时刻，一个处理器（对于多核处理器是一个内核）都只会执行一条线程中的指令，因为为了线程切换后能恢复到正确的执行位置，每条线程都需要有一个独立的程序计数器，各条线程之间计数器互不影响，我们称这类区域为“线程私有”的内存。



无锁--偏向锁--自旋锁--重量级锁

重量级 需要操作系统帮忙管理

轻量级 不需要操作系统帮忙管理  自己可以管理

虚拟寄存器 虚拟的pc

管理属于用户空间的线程   轻量级线程 --纤程  协程  

go 天然支持纤程

锁：锁定此对象本身  有一个等待队列  （重量级）

互斥锁：

CAS:compare and swap   产生ABA问题   加版本号  自旋锁在等待过程中（消耗资源） 

markword：锁信息

偏向锁：线程id号（第一个线程）

不存在竞争的情况下  而且提升效率

偏向锁撤销  

用CAS的方式去抢锁

synchronized的某一个中间状态是CAS



###### volalite

L1 l2 私有 

缓存行 64字节

缓存行的四中状态  遵守MESI(Inter)

怎么保证缓存一致性？

缓存一致性协议

线程可见性： MESI体现

指令重排序: cpu底层会优化  cpu乱序执行

happen-before

volalite怎样阻止指令重排序？

加屏障 memory barrier



###### 生产者消费者模式：

生产者消费者模式是程序设计中一种常见的设计模式，可以用来解耦、消息队列等。

![](/Users/guanghui/Library/Application Support/typora-user-images/image-20200627111748633.png)

使用生产者消费者模式通常需要在两者之间加一个阻塞队列作为媒介，有了媒介之后就相当有了一个缓冲，平衡了两者的能力，整体设计图如上所示







 

